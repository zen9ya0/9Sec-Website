<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nine-Security | Governance Automation SaaS</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0a0b0d; --card: #14171c; --border: #2a2f36; --text: #e0e0e0; --dim: #888; --green: #00ff9d; --warn: #ffa502; --fail: #ff4757; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; padding: 2rem; }
        h1 { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; color: var(--green); margin-bottom: 1.5rem; }
        .card-panel { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card-panel h2 { font-size: 1rem; color: var(--dim); margin: 0 0 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        input, button { padding: 10px 14px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.95rem; }
        input { background: #1a1f26; color: var(--text); width: 100%; }
        button { background: linear-gradient(135deg, rgba(0,255,157,0.2), rgba(0,212,255,0.15)); border-color: var(--green); color: var(--green); cursor: pointer; font-weight: 600; }
        button:hover { opacity: 0.9; }
        .btn-secondary { background: transparent; color: var(--dim); border-color: var(--border); }
        .form-row { margin-bottom: 1rem; }
        .form-row label { display: block; margin-bottom: 0.35rem; color: var(--dim); font-size: 0.85rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .tabs button { padding: 8px 16px; }
        .tabs button.active { background: rgba(0,255,157,0.15); color: var(--green); }
        .hidden { display: none !important; }
        #loginScreen { padding-top: 2rem; }
        #dashboard { display: none; }
        #dashboard.visible { display: block; }
        .user-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
        .user-bar span { color: var(--dim); font-size: 0.9rem; }
        .score-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        .score-a { background: rgba(0,255,157,0.2); color: var(--green); }
        .score-b { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .score-c { background: rgba(255,165,2,0.2); color: var(--warn); }
        .score-d { background: rgba(255,71,87,0.2); color: var(--fail); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--dim); font-weight: 600; }
        a { color: var(--green); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .msg { padding: 10px; border-radius: 6px; margin-bottom: 1rem; }
        .msg.err { background: rgba(255,71,87,0.15); color: var(--fail); }
        .msg.ok { background: rgba(0,255,157,0.1); color: var(--green); }
        .back-link { margin-bottom: 1rem; }
        .back-link a { color: var(--dim); font-size: 0.9rem; }
        .dashboard-panel { display: block; }
        .dashboard-panel.hidden { display: none !important; }
        .dashboard-body { display: flex; gap: 0; margin-top: 1rem; align-items: stretch; min-height: 360px; }
        .dashboard-sidebar { width: 160px; flex-shrink: 0; background: var(--card); border: 1px solid var(--border); border-right: none; border-radius: 8px 0 0 8px; padding: 12px 0; }
        .dashboard-sidebar .nav-label { padding: 0 14px 8px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--dim); }
        .dashboard-sidebar button { display: flex; align-items: center; gap: 8px; width: 100%; text-align: left; padding: 8px 14px; margin: 0; border: none; border-left: 3px solid transparent; border-radius: 0; background: transparent; color: var(--dim); cursor: pointer; font-size: 0.9rem; }
        .dashboard-sidebar button:hover { background: rgba(255,255,255,0.04); color: var(--text); }
        .dashboard-sidebar button.active { border-left-color: var(--green); background: rgba(0,255,157,0.08); color: var(--green); }
        .dashboard-main { flex: 1; min-width: 0; border: 1px solid var(--border); border-radius: 0 8px 8px 0; padding: 1.25rem; background: var(--card); }
        .env-block { margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: rgba(0,0,0,0.2); }
        .env-block h3 { font-size: 0.95rem; margin: 0 0 0.75rem; color: var(--green); }
        .btn-danger { background: rgba(255,71,87,0.2); border-color: var(--fail); color: var(--fail); }
        .btn-danger:hover { opacity: 0.9; }
        .toast { position: fixed; bottom: 1.5rem; left: 50%; z-index: 9999; background: var(--card); border: 1px solid var(--green); border-radius: 8px; padding: 14px 20px; color: var(--green); font-size: 0.95rem; box-shadow: 0 4px 20px rgba(0,0,0,0.4); transition: transform 0.25s ease, opacity 0.2s ease; visibility: hidden; opacity: 0; transform: translateX(-50%) translateY(1rem); pointer-events: none; }
        .toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
    </style>
</head>
<body>
    <div id="toast" class="toast" role="status" aria-live="polite" aria-hidden="true"></div>
    <div class="container">
        <div class="back-link"><a href="services.html"><i class="fa-solid fa-arrow-left"></i> Back to Services</a></div>
        <h1><i class="fa-solid fa-scale-balanced"></i> Governance Automation SaaS</h1>

        <div id="loginScreen">
            <div class="tabs">
                <button type="button" id="tabLogin" class="active">Sign In</button>
                <button type="button" id="tabSignup">Sign Up (7-Day Trial)</button>
            </div>
            <div id="loginForm" class="card-panel">
                <div id="loginMsg"></div>
                <div class="form-row"><label>Email</label><input type="email" id="loginEmail" placeholder="you@company.com"></div>
                <div class="form-row"><label>Password</label><input type="password" id="loginPassword" placeholder="••••••••"></div>
                <button type="button" id="btnLogin">Sign In</button>
            </div>
            <div id="signupForm" class="card-panel hidden">
                <div id="signupMsg"></div>
                <div class="form-row"><label>Organization Name</label><input type="text" id="signupOrg" placeholder="Acme Corp"></div>
                <div class="form-row"><label>Email</label><input type="email" id="signupEmail" placeholder="you@company.com"></div>
                <div class="form-row"><label>Password (min 8 characters)</label><input type="password" id="signupPassword" placeholder="••••••••"></div>
                <button type="button" id="btnSignup">Create Account</button>
            </div>
        </div>

        <div id="dashboard">
            <div class="user-bar">
                <span id="userInfo">—</span>
                <button type="button" id="btnNewTask"><i class="fa-solid fa-plus"></i> New Task</button>
                <button type="button" id="btnLogout" class="btn-secondary">Sign Out</button>
            </div>

            <div class="dashboard-body">
                <nav class="dashboard-sidebar" aria-label="Dashboard navigation">
                    <div class="nav-label">Menu</div>
                    <button type="button" id="dashTabOverview" class="active"><i class="fa-solid fa-chart-line" aria-hidden="true"></i> Overview</button>
                    <button type="button" id="dashTabEnvs"><i class="fa-solid fa-server" aria-hidden="true"></i> Environments</button>
                </nav>
                <main class="dashboard-main">
            <div id="panelOverview" class="dashboard-panel">
                <div class="card-panel">
                    <h2>Maturity Overview</h2>
                    <div id="insightsArea">Loading…</div>
                </div>
            </div>

            <div id="panelEnvs" class="dashboard-panel hidden">
                <div class="card-panel">
                    <h2>Environments</h2>
                    <p style="color:var(--dim);font-size:0.9rem;margin-bottom:1rem;">View all environments (endpoints), their collection tasks, and download links. You can clear all data for an environment.</p>
                    <div id="envsArea">Loading…</div>
                </div>
            </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://api.nine-security.com";
        let govCsrfToken = null;
        let csrfLogoutShown = false;

        function showMsg(elId, text, isErr) {
            const el = document.getElementById(elId);
            el.className = "msg " + (isErr ? "err" : "ok");
            el.textContent = text;
            el.classList.remove("hidden");
        }
        function hideMsg(elId) { document.getElementById(elId).classList.add("hidden"); }
        function showToast(message) {
            var el = document.getElementById("toast");
            if (!el) return;
            el.textContent = message;
            el.classList.add("show");
            clearTimeout(el._toastTimer);
            el._toastTimer = setTimeout(function() {
                el.classList.remove("show");
                el.textContent = "";
                el.setAttribute("aria-hidden", "true");
            }, 3500);
            el.setAttribute("aria-hidden", "false");
        }
        function escapeHtml(s) {
            if (s == null || s === "") return "";
            const t = String(s);
            return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }

        async function api(path, opts = {}) {
            const url = API_BASE + path;
            const method = (opts.method || "GET").toUpperCase();
            const headers = { ...(opts.headers || {}) };
            if (path.startsWith("/api/governance/") && (method === "POST" || method === "DELETE") && govCsrfToken) {
                headers["X-CSRF-Token"] = govCsrfToken;
            }
            const fetchOpts = { credentials: "include", ...opts };
            fetchOpts.headers = headers;
            const res = await fetch(url, fetchOpts);
            const contentType = res.headers.get("content-type") || "";
            if (contentType.includes("application/json")) return await res.json();
            return res;
        }

        function showDashboard() {
            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("dashboard").classList.add("visible");
            loadMe();
            loadInsights();
            switchDashboardTab("Overview");
        }

        function switchDashboardTab(name) {
            document.querySelectorAll(".dashboard-tabs button").forEach(b => { b.classList.remove("active"); });
            document.querySelectorAll(".dashboard-panel").forEach(p => p.classList.add("hidden"));
            if (name === "Overview") {
                document.getElementById("dashTabOverview").classList.add("active");
                document.getElementById("panelOverview").classList.remove("hidden");
            } else if (name === "Environments") {
                document.getElementById("dashTabEnvs").classList.add("active");
                document.getElementById("panelEnvs").classList.remove("hidden");
                loadEnvs();
            }
        }

        async function loadMe() {
            const j = await api("/api/governance/me");
            if (j && j.ok && j.user) {
                document.getElementById("userInfo").textContent = j.user.email + " · " + (j.user.org_name || "Org");
                if (j.csrf_token) govCsrfToken = j.csrf_token;
            }
        }

        async function loadInsights() {
            const el = document.getElementById("insightsArea");
            const j = await api("/api/governance/insights");
            if (!j || !j.ok) {
                el.innerHTML = j && j.data === null ? "<span style='color:var(--dim)'>No maturity report yet. Create a task and run the collector to see scores.</span>" : "<span class='err'>Failed to load insights.</span>";
                return;
            }
            const d = j.data;
            if (!d) {
                el.innerHTML = "<span style='color:var(--dim)'>No data.</span>";
                return;
            }
            const envs = d.environments || [];
            const summary = d.summary || {};
            if (envs.length === 0) {
                el.innerHTML = "<span style='color:var(--dim)'>No environments yet. Click <strong>New Task</strong> and enter an environment name to add one.</span>";
                return;
            }
            const avgScore = summary.overall_score_avg != null ? Math.round(summary.overall_score_avg) : null;
            const latestAt = summary.latest_at ? new Date(summary.latest_at).toLocaleString() : "—";
            let html = "<p><strong>Summary (all environments)</strong>";
            if (avgScore != null) {
                html += " &nbsp; <span class='score-badge score-a'>" + escapeHtml(String(avgScore)) + "/100 avg</span>";
            } else {
                html += " &nbsp; <span style='color:var(--dim)'>No reports yet</span>";
            }
            html += "</p><p style='color:var(--dim);font-size:0.85rem;'>Latest report: " + escapeHtml(latestAt) + " &nbsp; Environments: " + escapeHtml(String(summary.environment_count || envs.length)) + "</p>";
            envs.forEach(function(ev) {
                const r = ev.report;
                const name = escapeHtml(ev.env_name || ev.environment_id || "—");
                if (!r) {
                    html += "<p style='margin-top:0.75rem;'><strong>" + name + "</strong> <span style='color:var(--dim);font-size:0.9rem;'>— No report yet</span></p>";
                    return;
                }
                const score = r.overall_score != null ? Math.round(r.overall_score) : "—";
                const risk = (r.risk_level || "—").toUpperCase();
                const cls = risk === "A" ? "score-a" : risk === "B" ? "score-b" : risk === "C" ? "score-c" : "score-d";
                const date = r.created_at ? (typeof r.created_at === "number" ? new Date(r.created_at * 1000) : new Date(r.created_at)).toLocaleString() : "—";
                html += "<p style='margin-top:0.75rem;'><strong>" + name + "</strong> &nbsp; <span class='score-badge " + cls + "'>" + escapeHtml(score) + "/100</span> <span class='score-badge " + cls + "'>" + escapeHtml(risk) + "</span> <span style='color:var(--dim);font-size:0.85rem;'>" + escapeHtml(date) + "</span></p>";
                if (ev.domains && ev.domains.length) {
                    html += "<table style='margin-left:1rem;margin-top:0.25rem;font-size:0.85rem;'><tr><th>Domain</th><th>Score</th></tr>" +
                        ev.domains.map(function(x) { return "<tr><td>" + escapeHtml(x.domain_name || "—") + "</td><td>" + escapeHtml(x.score != null ? Math.round(x.score) : "—") + "</td></tr>"; }).join("") + "</table>";
                }
            });
            el.innerHTML = html;
        }

        async function loadEnvs() {
            const el = document.getElementById("envsArea");
            el.textContent = "Loading…";
            if (!govCsrfToken) {
                try {
                    const me = await api("/api/governance/me");
                    if (me && me.ok && me.csrf_token) govCsrfToken = me.csrf_token;
                } catch (_) {}
            }
            try {
                const [envRes, tasksRes] = await Promise.all([
                    api("/api/governance/environments"),
                    api("/api/governance/tasks")
                ]);
                const envs = (envRes && envRes.ok && envRes.data) ? envRes.data : [];
                const tasks = (tasksRes && tasksRes.ok && tasksRes.data) ? tasksRes.data : [];
                const byEnv = {};
                envs.forEach(e => { byEnv[e.id] = { name: e.name || e.id, tasks: [] }; });
                tasks.forEach(t => {
                    const eid = t.environment_id || "";
                    if (!byEnv[eid]) byEnv[eid] = { name: t.env_name || eid || "—", tasks: [] };
                    byEnv[eid].tasks.push(t);
                });
                if (envs.length === 0 && Object.keys(byEnv).length === 0) {
                    el.innerHTML = "<p style='color:var(--dim)'>No environments yet. Click <strong>New Task</strong> in the bar above and enter an environment name to create one.</p>";
                    return;
                }
                const envIds = envs.length ? envs.map(e => e.id) : Object.keys(byEnv);
                el.innerHTML = envIds.map(envId => {
                    const block = byEnv[envId] || { name: envId, tasks: [] };
                    const displayName = escapeHtml(block.name || envId);
                    const taskRows = (block.tasks || []).map(t => {
                        const created = t.created_at ? (typeof t.created_at === 'number' ? new Date(t.created_at * 1000) : new Date(t.created_at)).toLocaleString() : "—";
                        const status = (t.status || "pending").toLowerCase();
                        const downloadUrl = API_BASE + "/api/governance/download/" + encodeURIComponent(t.id) + "?token=" + encodeURIComponent(t.token || "");
                        const action = status === "pending" ? "<a href=\"" + escapeHtml(downloadUrl) + "\" target=\"_blank\" rel=\"noopener noreferrer\">Download ZIP</a>" : "—";
                        return "<tr><td>" + escapeHtml(created) + "</td><td>" + escapeHtml(status) + "</td><td>" + action + "</td></tr>";
                    }).join("");
                    const tableHtml = block.tasks && block.tasks.length
                        ? "<table style='margin-top:0.5rem;'><thead><tr><th>Created</th><th>Status</th><th>Action</th></tr></thead><tbody>" + taskRows + "</tbody></table>"
                        : "<p style='color:var(--dim);font-size:0.9rem;margin-top:0.5rem;'>No tasks for this environment.</p>";
                    return "<div class=\"env-block\" data-env-id=\"" + escapeHtml(envId) + "\"><h3><i class=\"fa-solid fa-server\"></i> " + displayName + "</h3>" + tableHtml + "<button type=\"button\" class=\"btn-danger\" style=\"margin-top:0.75rem;\" data-clear-env=\"" + escapeHtml(envId) + "\"><i class=\"fa-solid fa-trash-can\"></i> Clear environment data</button></div>";
                }).join("");
                // Clear buttons use event delegation (see dashboard click handler below)
            } catch (e) {
                el.innerHTML = "<p class=\"msg err\">Failed to load environments.</p>";
            }
        }

        document.getElementById("tabLogin").addEventListener("click", () => {
            document.getElementById("tabLogin").classList.add("active");
            document.getElementById("tabSignup").classList.remove("active");
            document.getElementById("loginForm").classList.remove("hidden");
            document.getElementById("signupForm").classList.add("hidden");
        });
        document.getElementById("tabSignup").addEventListener("click", () => {
            document.getElementById("tabSignup").classList.add("active");
            document.getElementById("tabLogin").classList.remove("active");
            document.getElementById("signupForm").classList.remove("hidden");
            document.getElementById("loginForm").classList.add("hidden");
        });

        document.getElementById("btnLogin").addEventListener("click", async () => {
            hideMsg("loginMsg");
            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;
            if (!email || !password) { showMsg("loginMsg", "Please enter email and password.", true); return; }
            try {
                const j = await api("/api/governance/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                if (j && j.ok) {
                    govCsrfToken = j.csrf_token || null;
                    csrfLogoutShown = false;
                    showDashboard();
                    return;
                }
                showMsg("loginMsg", (j && j.error) || "Login failed.", true);
            } catch (e) {
                showMsg("loginMsg", "Network error: " + (e.message || "Cannot reach backend. Check API_BASE and CORS."), true);
            }
        });

        document.getElementById("btnSignup").addEventListener("click", async () => {
            hideMsg("signupMsg");
            const org_name = document.getElementById("signupOrg").value.trim();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            if (!org_name || !email || !password) { showMsg("signupMsg", "Please fill all fields.", true); return; }
            if (password.length < 8) { showMsg("signupMsg", "Password must be at least 8 characters.", true); return; }
            try {
                const res = await fetch(API_BASE + "/api/governance/signup", {
                    method: "POST",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password, org_name })
                });
                let j = null;
                const ct = res.headers.get("content-type") || "";
                if (ct.includes("application/json")) {
                    j = await res.json();
                } else {
                    const text = await res.text();
                    try { j = JSON.parse(text); } catch (_) { j = { ok: false, error: text || "Signup failed." }; }
                }
                if (j && j.ok) { showMsg("signupMsg", "Account created. You can sign in now.", false); return; }
                showMsg("signupMsg", (j && j.error) || "Signup failed. Please try again or contact support.", true);
            } catch (e) {
                showMsg("signupMsg", "Network error: " + (e.message || "Cannot reach backend. Check API_BASE and CORS."), true);
            }
        });

        document.getElementById("btnLogout").addEventListener("click", async () => {
            await api("/api/governance/logout", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
            govCsrfToken = null;
            document.getElementById("dashboard").classList.remove("visible");
            document.getElementById("loginScreen").classList.remove("hidden");
        });

        async function runNewTask() {
            var envName = prompt("Environment Name (e.g. HQ Office, Server-A). This matches the Environments tab; each environment has its own task list.");
            if (envName == null || !String(envName).trim()) return;
            if (!govCsrfToken) {
                try {
                    var me = await api("/api/governance/me");
                    if (me && me.ok && me.csrf_token) govCsrfToken = me.csrf_token;
                } catch (_) {}
            }
            if (!govCsrfToken) {
                showToast("Session expired. Please sign out and sign in again.");
                return;
            }
            try {
                var j = await api("/api/governance/session", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ environment_id: String(envName).trim() })
                });
                if (!j || !j.ok) {
                    var errMsg = (j && j.error) ? String(j.error) : "Failed to create task.";
                    if (errMsg.indexOf("CSRF") !== -1 || errMsg.indexOf("Invalid session") !== -1) {
                        govCsrfToken = null;
                        if (!csrfLogoutShown) {
                            csrfLogoutShown = true;
                            showToast("Session expired. Signing out…");
                            await api("/api/governance/logout", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
                            document.getElementById("dashboard").classList.remove("visible");
                            document.getElementById("loginScreen").classList.remove("hidden");
                        }
                    } else {
                        showToast(errMsg);
                    }
                    return;
                }
                var d = j.data;
                var downloadUrl = API_BASE + "/api/governance/download/" + d.upload_session_id + "?token=" + encodeURIComponent(d.token);
                showToast("Task created. Preparing download…");
                var panelEnvs = document.getElementById("panelEnvs");
                if (panelEnvs && !panelEnvs.classList.contains("hidden")) loadEnvs();
                loadInsights();
                (async function() {
                    try {
                        var r = await fetch(downloadUrl, { credentials: "include" });
                        if (!r.ok) {
                            var errText = await r.text();
                            showToast(errText || "Download failed.");
                            return;
                        }
                        var blob = await r.blob();
                        var a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        a.download = "governance-collector.zip";
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(a.href);
                        showToast("Collector ZIP downloaded.");
                    } catch (err) {
                        showToast("Download failed: " + (err.message || "network error"));
                    }
                })();
            } catch (err) {
                showToast("Request failed: " + (err.message || "network error"));
            }
        }

        function handleDashboardClick(e) {
            var el = e.target;
            if (!el || !el.closest) return;
            if (el.closest("#btnNewTask")) {
                e.preventDefault();
                e.stopPropagation();
                runNewTask();
                return;
            }
            if (el.closest("[data-clear-env]")) {
                e.preventDefault();
                e.stopPropagation();
                var btn = el.closest("[data-clear-env]");
                var id = btn && btn.getAttribute("data-clear-env");
                if (!id) return;
                if (!confirm("Clear all reports and tasks for this environment? This cannot be undone.")) return;
                (async function() {
                    try {
                        if (!govCsrfToken) {
                            var me = await api("/api/governance/me");
                            if (me && me.ok && me.csrf_token) govCsrfToken = me.csrf_token;
                        }
                        if (!govCsrfToken) { showToast("Session expired. Please sign out and sign in again."); return; }
                        var j = await api("/api/governance/environment/" + encodeURIComponent(id) + "/data", { method: "DELETE" });
                        if (!j || !j.ok) {
                            var errMsg = (j && j.error) ? String(j.error) : "Failed to clear.";
                            if (errMsg.indexOf("CSRF") !== -1 || errMsg.indexOf("Invalid session") !== -1) {
                                govCsrfToken = null;
                                if (!csrfLogoutShown) {
                                    csrfLogoutShown = true;
                                    showToast("Session expired. Signing out…");
                                    await api("/api/governance/logout", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
                                    document.getElementById("dashboard").classList.remove("visible");
                                    document.getElementById("loginScreen").classList.remove("hidden");
                                }
                            } else {
                                showToast(errMsg);
                            }
                            return;
                        }
                        loadEnvs();
                        loadInsights();
                        showToast("Environment data cleared.");
                    } catch (err) { showToast("Request failed: " + (err.message || "network error")); }
                })();
                return;
            }
            if (el.closest("#dashTabOverview")) { switchDashboardTab("Overview"); return; }
            if (el.closest("#dashTabEnvs")) { switchDashboardTab("Environments"); return; }
        }

        document.body.addEventListener("click", handleDashboardClick, true);
        var btnNewTaskEl = document.getElementById("btnNewTask");
        if (btnNewTaskEl) {
            btnNewTaskEl.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                runNewTask();
            }, false);
        }

        (async function init() {
            try {
                const j = await api("/api/governance/me");
                if (j && j.ok && j.user) {
                    if (j.csrf_token) govCsrfToken = j.csrf_token;
                    showDashboard();
                }
            } catch (e) { /* silent */ }
        })();
    </script>
</body>
</html>

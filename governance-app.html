<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nine-Security | Governance Automation SaaS</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0a0b0d; --card: #14171c; --border: #2a2f36; --text: #e0e0e0; --dim: #888; --green: #00ff9d; --warn: #ffa502; --fail: #ff4757; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        h1 { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; color: var(--green); margin-bottom: 1.5rem; }
        .card-panel { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card-panel h2 { font-size: 1rem; color: var(--dim); margin: 0 0 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        input, button { padding: 10px 14px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.95rem; }
        input { background: #1a1f26; color: var(--text); width: 100%; }
        button { background: linear-gradient(135deg, rgba(0,255,157,0.2), rgba(0,212,255,0.15)); border-color: var(--green); color: var(--green); cursor: pointer; font-weight: 600; }
        button:hover { opacity: 0.9; }
        .btn-secondary { background: transparent; color: var(--dim); border-color: var(--border); }
        .form-row { margin-bottom: 1rem; }
        .form-row label { display: block; margin-bottom: 0.35rem; color: var(--dim); font-size: 0.85rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .tabs button { padding: 8px 16px; }
        .tabs button.active { background: rgba(0,255,157,0.15); color: var(--green); }
        .hidden { display: none !important; }
        #loginScreen { padding-top: 2rem; }
        #dashboard { display: none; }
        #dashboard.visible { display: block; }
        .user-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem; }
        .user-bar span { color: var(--dim); font-size: 0.9rem; }
        .score-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-family: 'JetBrains Mono', monospace; }
        .score-a { background: rgba(0,255,157,0.2); color: var(--green); }
        .score-b { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .score-c { background: rgba(255,165,2,0.2); color: var(--warn); }
        .score-d { background: rgba(255,71,87,0.2); color: var(--fail); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--dim); font-weight: 600; }
        a { color: var(--green); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .msg { padding: 10px; border-radius: 6px; margin-bottom: 1rem; }
        .msg.err { background: rgba(255,71,87,0.15); color: var(--fail); }
        .msg.ok { background: rgba(0,255,157,0.1); color: var(--green); }
        .back-link { margin-bottom: 1rem; }
        .back-link a { color: var(--dim); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-link"><a href="services.html"><i class="fa-solid fa-arrow-left"></i> Back to Services</a></div>
        <h1><i class="fa-solid fa-scale-balanced"></i> Governance Automation SaaS</h1>

        <div id="loginScreen">
            <div class="tabs">
                <button type="button" id="tabLogin" class="active">Sign In</button>
                <button type="button" id="tabSignup">Sign Up (7-Day Trial)</button>
            </div>
            <div id="loginForm" class="card-panel">
                <div id="loginMsg"></div>
                <div class="form-row"><label>Email</label><input type="email" id="loginEmail" placeholder="you@company.com"></div>
                <div class="form-row"><label>Password</label><input type="password" id="loginPassword" placeholder="••••••••"></div>
                <button type="button" id="btnLogin">Sign In</button>
            </div>
            <div id="signupForm" class="card-panel hidden">
                <div id="signupMsg"></div>
                <div class="form-row"><label>Organization Name</label><input type="text" id="signupOrg" placeholder="Acme Corp"></div>
                <div class="form-row"><label>Email</label><input type="email" id="signupEmail" placeholder="you@company.com"></div>
                <div class="form-row"><label>Password (min 8 characters)</label><input type="password" id="signupPassword" placeholder="••••••••"></div>
                <button type="button" id="btnSignup">Create Account</button>
            </div>
        </div>

        <div id="dashboard">
            <div class="user-bar">
                <span id="userInfo">—</span>
                <button type="button" id="btnLogout" class="btn-secondary">Sign Out</button>
            </div>

            <div class="card-panel">
                <h2>Maturity Overview</h2>
                <div id="insightsArea">Loading…</div>
            </div>

            <div class="card-panel">
                <h2>Collection Tasks</h2>
                <p style="color:var(--dim);font-size:0.9rem;margin-bottom:1rem;">Create a task to download the collector ZIP. Run collector.exe on the target machine to upload evidence.</p>
                <button type="button" id="btnCreateTask"><i class="fa-solid fa-plus"></i> Create Collection Task</button>
                <div id="createTaskResult" class="hidden"></div>
                <table style="margin-top:1.5rem;">
                    <thead><tr><th>Created</th><th>Environment</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="tasksBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://api.nine-security.com";

        function showMsg(elId, text, isErr) {
            const el = document.getElementById(elId);
            el.className = "msg " + (isErr ? "err" : "ok");
            el.textContent = text;
            el.classList.remove("hidden");
        }
        function hideMsg(elId) { document.getElementById(elId).classList.add("hidden"); }

        async function api(path, opts = {}) {
            const url = API_BASE + path;
            const res = await fetch(url, { credentials: "include", ...opts });
            const contentType = res.headers.get("content-type") || "";
            if (contentType.includes("application/json")) return await res.json();
            return res;
        }

        function showDashboard() {
            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("dashboard").classList.add("visible");
            loadMe();
            loadTasks();
            loadInsights();
        }

        async function loadMe() {
            const j = await api("/api/governance/me");
            if (j && j.ok && j.user) {
                document.getElementById("userInfo").textContent = j.user.email + " · " + (j.user.org_name || "Org");
            }
        }

        async function loadInsights() {
            const el = document.getElementById("insightsArea");
            const j = await api("/api/governance/insights");
            if (!j || !j.ok) {
                el.innerHTML = j && j.data === null ? "<span style='color:var(--dim)'>No maturity report yet. Create a task and run the collector to see scores.</span>" : "<span class='err'>Failed to load insights.</span>";
                return;
            }
            const d = j.data;
            if (!d || !d.report) {
                el.innerHTML = "<span style='color:var(--dim)'>No maturity report yet. Run the collector and upload evidence.</span>";
                return;
            }
            const r = d.report;
            const score = r.overall_score != null ? Math.round(r.overall_score) : "—";
            const risk = (r.risk_level || "—").toUpperCase();
            const cls = risk === "A" ? "score-a" : risk === "B" ? "score-b" : risk === "C" ? "score-c" : "score-d";
            const date = r.created_at ? (typeof r.created_at === 'number' ? new Date(r.created_at * 1000) : new Date(r.created_at)).toLocaleString() : "—";
            let domainsHtml = "";
            if (d.domains && d.domains.length) {
                domainsHtml = "<table style='margin-top:0.75rem;'><tr><th>Domain</th><th>Score</th></tr>" +
                    d.domains.map(x => "<tr><td>" + (x.domain_name || "—") + "</td><td>" + (x.score != null ? Math.round(x.score) : "—") + "</td></tr>").join("") + "</table>";
            }
            el.innerHTML = "<p><strong>Overall Score</strong> <span class='score-badge " + cls + "'>" + score + "/100</span> &nbsp; <strong>Risk Level</strong> <span class='score-badge " + cls + "'>" + risk + "</span></p><p style='color:var(--dim);font-size:0.85rem;'>Last report: " + date + "</p>" + domainsHtml;
        }

        async function loadTasks() {
            const j = await api("/api/governance/tasks");
            const tbody = document.getElementById("tasksBody");
            if (!j || !j.ok || !j.data || !j.data.length) {
                tbody.innerHTML = "<tr><td colspan='4' style='color:var(--dim)'>No tasks yet.</td></tr>";
                return;
            }
            tbody.innerHTML = j.data.map(t => {
                const created = t.created_at ? (typeof t.created_at === 'number' ? new Date(t.created_at * 1000) : new Date(t.created_at)).toLocaleString() : "—";
                const envName = t.env_name || t.environment_id || "—";
                const status = (t.status || "pending").toLowerCase();
                const downloadUrl = API_BASE + "/api/governance/download/" + t.id + "?token=" + encodeURIComponent(t.token || "");
                const action = status === "pending" ? "<a href=\"" + downloadUrl + "\" target=\"_blank\">Download ZIP</a>" : "—";
                return "<tr><td>" + created + "</td><td>" + envName + "</td><td>" + status + "</td><td>" + action + "</td></tr>";
            }).join("");
        }

        document.getElementById("tabLogin").addEventListener("click", () => {
            document.getElementById("tabLogin").classList.add("active");
            document.getElementById("tabSignup").classList.remove("active");
            document.getElementById("loginForm").classList.remove("hidden");
            document.getElementById("signupForm").classList.add("hidden");
        });
        document.getElementById("tabSignup").addEventListener("click", () => {
            document.getElementById("tabSignup").classList.add("active");
            document.getElementById("tabLogin").classList.remove("active");
            document.getElementById("signupForm").classList.remove("hidden");
            document.getElementById("loginForm").classList.add("hidden");
        });

        document.getElementById("btnLogin").addEventListener("click", async () => {
            hideMsg("loginMsg");
            const email = document.getElementById("loginEmail").value.trim();
            const password = document.getElementById("loginPassword").value;
            if (!email || !password) { showMsg("loginMsg", "Please enter email and password.", true); return; }
            try {
                const j = await api("/api/governance/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                if (j && j.ok) { showDashboard(); return; }
                showMsg("loginMsg", (j && j.error) || "Login failed.", true);
            } catch (e) {
                showMsg("loginMsg", "Network error: " + (e.message || "Cannot reach backend. Check API_BASE and CORS."), true);
            }
        });

        document.getElementById("btnSignup").addEventListener("click", async () => {
            hideMsg("signupMsg");
            const org_name = document.getElementById("signupOrg").value.trim();
            const email = document.getElementById("signupEmail").value.trim();
            const password = document.getElementById("signupPassword").value;
            if (!org_name || !email || !password) { showMsg("signupMsg", "Please fill all fields.", true); return; }
            if (password.length < 8) { showMsg("signupMsg", "Password must be at least 8 characters.", true); return; }
            try {
                const j = await api("/api/governance/signup", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password, org_name })
                });
                if (j && j.ok) { showMsg("signupMsg", "Account created. You can sign in now.", false); return; }
                showMsg("signupMsg", (j && j.error) || "Signup failed.", true);
            } catch (e) {
                showMsg("signupMsg", "Network error: " + (e.message || "Cannot reach backend. Check API_BASE and CORS."), true);
            }
        });

        document.getElementById("btnLogout").addEventListener("click", async () => {
            await api("/api/governance/logout", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
            document.getElementById("dashboard").classList.remove("visible");
            document.getElementById("loginScreen").classList.remove("hidden");
        });

        document.getElementById("btnCreateTask").addEventListener("click", async () => {
            const resultEl = document.getElementById("createTaskResult");
            resultEl.classList.add("hidden");
            const j = await api("/api/governance/session", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({})
            });
            if (!j || !j.ok) {
                resultEl.className = "msg err";
                resultEl.textContent = (j && j.error) || "Failed to create task.";
                resultEl.classList.remove("hidden");
                return;
            }
            const d = j.data;
            const downloadUrl = API_BASE + "/api/governance/download/" + d.upload_session_id + "?token=" + encodeURIComponent(d.token);
            resultEl.className = "msg ok";
            resultEl.innerHTML = "Task created. <a href=\"" + downloadUrl + "\" target=\"_blank\">Download collector ZIP</a> (valid 12 hours).";
            resultEl.classList.remove("hidden");
            loadTasks();
        });

        (async function init() {
            try {
                const j = await api("/api/governance/me");
                if (j && j.ok && j.user) showDashboard();
            } catch (e) { /* silent */ }
        })();
    </script>
</body>
</html>

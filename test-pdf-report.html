<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Report 底層測試</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #1a1a1a; color: #eee; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; }
        button { padding: 10px 16px; margin: 4px; cursor: pointer; }
        #report-visible { width: 720px; padding: 28px 32px; background: #0a0a0a; color: #e0e0e0; font-family: 'Courier New', monospace; font-size: 11px; }
        .pdf-header { border-bottom: 2px solid #00ff41; padding-bottom: 14px; margin-bottom: 20px; }
        .pdf-header h1 { color: #00ff41; margin: 0; font-size: 14px; }
        .pdf-section-title { color: #00ff41; margin: 18px 0 10px; font-size: 11px; border-left: 4px solid #00ff41; padding-left: 12px; }
        .pdf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 14px; }
        .pdf-card { background: #111; border: 1px solid #333; padding: 12px; }
        .pdf-label { color: #666; font-size: 9px; text-transform: uppercase; }
        .pdf-value { font-size: 11px; font-weight: bold; }
        .log { margin-top: 10px; padding: 10px; background: #000; color: #0f0; font-size: 12px; max-height: 200px; overflow: auto; }
    </style>
</head>
<body>
    <h1>PDF 報告底層測試</h1>
    <p>此頁用於驗證 html2pdf 擷取流程。注意：html2pdf 會 clone 節點至 iframe，常產出<strong>空白 PDF</strong>；正式站 <code>smtp-check.html</code> 已改為「Download PDF → 開啟報告頁 → 列印 → 另存為 PDF」以保證有內容。</p>

    <div class="test-section">
        <h2>方式 A：擷取「頁面上已存在的」報告區塊</h2>
        <p>下方區塊是報告內容，一直在 DOM 裡且可見。</p>
        <div id="report-visible">
            <div class="pdf-header">
                <h1>NINE-SECURITY // ASSESSMENT_LOG</h1>
                <p>Target Domain: <span style="color:#00ff41">example.com</span></p>
                <p class="pdf-meta">Generated: <span id="gen-time"></span></p>
            </div>
            <div class="pdf-section-title">> EXECUTIVE_RISK_PROFILE [Score: 75/100]</div>
            <div class="pdf-section-title">> AUTH_INFRASTRUCTURE_PROBE</div>
            <div class="pdf-grid">
                <div class="pdf-card"><div class="pdf-label">Origin MTA Node</div><div class="pdf-value">Generic MTA</div></div>
                <div class="pdf-card"><div class="pdf-label">SPF Governance</div><div class="pdf-value" style="color:#00ff41">PASS</div></div>
                <div class="pdf-card"><div class="pdf-label">DMARC</div><div class="pdf-value" style="color:#ffaa00">WARN</div></div>
                <div class="pdf-card"><div class="pdf-label">Transport</div><div class="pdf-value">TLS 1.3</div></div>
            </div>
            <div class="pdf-section-title">> ADVANCED_SECURITY_PROTOCOLS</div>
            <div class="pdf-grid">
                <div class="pdf-card"><div class="pdf-label">MTA-STS</div><div class="pdf-value" style="color:#00ff41">PASS</div></div>
                <div class="pdf-card"><div class="pdf-label">BIMI</div><div class="pdf-value" style="color:#ff0055">MISSING</div></div>
            </div>
            <p style="margin-top:20px;color:#444;font-size:9px;">CONFIDENTIAL - NINE-SECURITY.INC</p>
        </div>
        <button id="btn-pdf-visible">Download PDF（擷取上方區塊）</button>
    </div>

    <div class="test-section">
        <h2>方式 B：動態建立 div 再擷取（模擬正式流程）</h2>
        <button id="btn-pdf-dynamic">Download PDF（動態建立）</button>
    </div>

    <div class="test-section">
        <h2>方式 C：模擬 smtp-check 報告區塊（原本 hidden，強制顯示後擷取）</h2>
        <p>下方區塊結構與 <code>smtp-check.html</code> 的 <code>#smtp-step-report</code> 一致，預設為 <code>display:none</code>，點擊後套用與正式流程相同的強制顯示邏輯再擷取。</p>
        <style>
            .smtp-step.hidden { display: none; }
            #smtp-step-report-test .report-header { border-bottom: 2px solid #333; padding-bottom: 14px; margin-bottom: 20px; }
            #smtp-step-report-test .report-header h3 { color: #00ff41; margin: 0; }
            #smtp-step-report-test .section-title { color: #00ff41; margin: 18px 0 10px; font-size: 11px; border-left: 4px solid #00ff41; padding-left: 12px; }
            #smtp-step-report-test .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 14px; }
            #smtp-step-report-test .card { background: #111; border: 1px solid #333; padding: 12px; }
            #smtp-step-report-test .label { color: #666; font-size: 9px; text-transform: uppercase; }
            #smtp-step-report-test .value { font-size: 11px; font-weight: bold; }
        </style>
        <div id="smtp-step-report-test" class="smtp-step hidden" style="background:#0a0a0a;color:#e0e0e0;font-family:'Courier New',monospace;width:720px;padding:24px;box-sizing:border-box;">
            <div class="report-header">
                <div class="report-status status-ok">[COMPLETED]</div>
                <h3 id="report-domain-test">example.com</h3>
            </div>
            <div class="report-grid" id="report-content-test">
                <div class="section-title">> Executive Risk Profile (Score: 75/100)</div>
                <div class="risk-container">
                    <div class="risk-item" style="border-left:4px solid #ff0055;"><span>DMARC none</span><span class="value pass">+20</span></div>
                    <div class="risk-item" style="border-left:4px solid #ffaa00;"><span>MTA-STS missing</span><span class="value pass">+10</span></div>
                </div>
                <div class="section-title">> Authentication Infrastructure</div>
                <div class="grid">
                    <div class="card"><div class="label">SPF</div><div class="value" style="color:#00ff41">PASS</div></div>
                    <div class="card"><div class="label">DMARC</div><div class="value" style="color:#ffaa00">NONE</div></div>
                </div>
                <div class="cta-box" style="border:1px solid #00ff41;padding:20px;margin-top:24px;text-align:center;">
                    <h3 style="color:#00ff41;margin-top:0;">Forensic Report</h3>
                    <p>consult@nine-security.com</p>
                </div>
            </div>
            <div class="report-actions" style="margin-top:1rem;display:flex;gap:0.5rem;">
                <button type="button">Download HTML</button>
                <button type="button">Download PDF</button>
            </div>
        </div>
        <button id="btn-pdf-smtp-mock">Download PDF（方式 C：hidden → 強制顯示 → 擷取）</button>
    </div>

    <div class="test-section">
        <h2>Console 輸出</h2>
        <pre id="log" class="log"></pre>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        document.getElementById('gen-time').textContent = new Date().toLocaleString();

        function log(msg) {
            const pre = document.getElementById('log');
            pre.textContent += msg + '\n';
            pre.scrollTop = pre.scrollHeight;
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        document.getElementById('btn-pdf-visible').addEventListener('click', () => {
            clearLog();
            const el = document.getElementById('report-visible');
            log('方式 A: 開始擷取 #report-visible, html2pdf 存在: ' + (typeof html2pdf !== 'undefined'));
            if (typeof html2pdf === 'undefined') {
                log('錯誤: html2pdf 未載入');
                return;
            }
            html2pdf()
                .set({
                    margin: 12,
                    filename: '9Sec_Test_Visible.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                })
                .from(el)
                .save()
                .then(() => log('方式 A: PDF 已儲存'))
                .catch((err) => log('方式 A 錯誤: ' + err.message));
        });

        document.getElementById('btn-pdf-dynamic').addEventListener('click', () => {
            clearLog();
            log('方式 B: 動態建立 wrapper');
            const wrapper = document.createElement('div');
            wrapper.id = 'pdf-dynamic-root';
            wrapper.style.cssText = 'position:fixed;top:0;left:0;width:720px;background:#0a0a0a;color:#e0e0e0;z-index:99999;padding:28px 32px;';
            wrapper.innerHTML = '<div class="pdf-header"><h1>NINE-SECURITY // TEST</h1><p>Target: dynamic.example.com</p></div>' +
                '<div class="pdf-section-title">> DYNAMIC BLOCK</div>' +
                '<div class="pdf-grid"><div class="pdf-card"><div class="pdf-label">Key</div><div class="pdf-value">Value</div></div></div>' +
                '<p style="color:#444;font-size:9px;">Footer</p>';
            document.body.appendChild(wrapper);
            log('方式 B: wrapper 已 append, offsetHeight=' + wrapper.offsetHeight);

            const opt = {
                margin: 12,
                filename: '9Sec_Test_Dynamic.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(wrapper).save()
                .then(() => {
                    log('方式 B: PDF 已儲存');
                    if (wrapper.parentNode) document.body.removeChild(wrapper);
                })
                .catch((err) => {
                    log('方式 B 錯誤: ' + err.message);
                    if (wrapper.parentNode) document.body.removeChild(wrapper);
                });
        });

        // 方式 C：與 script.js PDF 下載邏輯一致（hidden 區塊 → 強制顯示 → 擷取）
        document.getElementById('btn-pdf-smtp-mock').addEventListener('click', () => {
            clearLog();
            const reportStep = document.getElementById('smtp-step-report-test');
            const reportActions = reportStep && reportStep.querySelector('.report-actions');
            if (!reportStep) { log('方式 C: 找不到 #smtp-step-report-test'); return; }
            if (typeof html2pdf === 'undefined') { log('方式 C: html2pdf 未載入'); return; }

            const originalStepStyle = reportStep.getAttribute('style') || '';
            const originalActionsDisplay = reportActions ? reportActions.style.display : '';
            const hadHidden = reportStep.classList.contains('hidden');
            log('方式 C: hadHidden=' + hadHidden + ', offsetHeight(擷取前)=' + reportStep.offsetHeight);

            reportStep.classList.remove('hidden');
            reportStep.style.display = 'block';
            reportStep.style.visibility = 'visible';
            reportStep.style.opacity = '1';
            reportStep.style.position = 'fixed';
            reportStep.style.top = '0';
            reportStep.style.left = '0';
            reportStep.style.zIndex = '99999';
            reportStep.style.background = '#0a0a0a';
            reportStep.style.width = '720px';
            reportStep.style.maxWidth = '100vw';
            reportStep.style.maxHeight = '100vh';
            reportStep.style.overflow = 'auto';
            reportStep.style.padding = '24px';
            reportStep.style.boxSizing = 'border-box';
            if (reportActions) reportActions.style.display = 'none';
            log('方式 C: 強制顯示後 offsetHeight=' + reportStep.offsetHeight);

            const restore = () => {
                reportStep.removeAttribute('style');
                if (originalStepStyle) reportStep.setAttribute('style', originalStepStyle);
                if (hadHidden) reportStep.classList.add('hidden');
                if (reportActions) reportActions.style.display = originalActionsDisplay;
            };

            const filename = '9Sec_Test_SmtpMock.pdf';
            const opt = {
                margin: 12,
                filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true, allowTaint: true, logging: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css'], avoid: ['.card', '.risk-item', '.section-title', '.report-header', '.report-grid', '.cta-box'] }
            };
            html2pdf().set(opt).from(reportStep).outputPdf('blob')
                .then((blob) => {
                    const pdfBlob = blob instanceof Blob ? blob : new Blob([blob], { type: 'application/pdf' });
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    restore();
                    log('方式 C: PDF 已儲存 (blob 手動下載)');
                })
                .catch((err) => { restore(); log('方式 C 錯誤: ' + err.message); });
        });
    </script>
</body>
</html>
